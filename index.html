<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Design Insight Curator</title>
  <style>
    *{box-sizing:border-box;margin:0;padding:0;font-family:'Pretendard', 'Noto Sans KR', sans-serif}
    body{
      background:linear-gradient(135deg,#FFD3A5 0%,#FD6585 100%);
      min-height:100vh; display:flex; flex-direction:column; align-items:center; padding:40px 20px; color:#333;
    }
    h1{font-size:2rem;font-weight:700;color:#fff;margin-bottom:20px}
    .input-container{
      background:rgba(255,255,255,0.95); border-radius:20px; box-shadow:0 8px 20px rgba(0,0,0,0.1);
      padding:20px; width:100%; max-width:500px; margin-bottom:30px; display:flex; flex-direction:column; gap:10px;
    }
    .input-container input, .input-container textarea, .input-container select{
      width:100%; border:none; border-radius:10px; padding:12px 14px; font-size:1rem; outline:none; background:#f8f8f8;
    }
    .add-btn{
      align-self:flex-end; background:linear-gradient(135deg,#FD6585,#FFD3A5); color:#fff; border:none; border-radius:30px;
      padding:10px 20px; font-size:.9rem; cursor:pointer; font-weight:600; transition:.2s;
    }
    .add-btn:hover{transform:scale(1.04)}
    .filter-bar{display:flex;flex-wrap:wrap;justify-content:center;gap:10px;margin-bottom:20px;width:100%;max-width:800px}
    #searchInput,#categoryFilter{padding:10px 14px;border:none;border-radius:20px;font-size:1rem;outline:none;
      box-shadow:0 3px 10px rgba(0,0,0,0.1)}
    .card-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:24px;width:100%;max-width:1080px}
    .card{background:#fff;border-radius:24px;box-shadow:0 8px 24px rgba(0,0,0,0.08);overflow:hidden;display:flex;flex-direction:column;transition:.3s;cursor:grab}
    .card.dragging{opacity:.5;transform:scale(.98)}
    .card img{width:100%;height:160px;object-fit:cover;cursor:pointer;user-select:none}
    .card-content{padding:16px 20px;display:flex;flex-direction:column;gap:10px}
    .card h3{font-size:1.2rem;font-weight:600;background:linear-gradient(135deg,#FD6585,#FFD3A5);-webkit-background-clip:text;color:transparent}
    .card p{color:#555;font-size:.95rem;line-height:1.4}
    .tags{display:flex;flex-wrap:wrap;gap:6px}
    .tag{background:#FFD3A5;color:#333;padding:4px 10px;border-radius:10px;font-size:.8rem;cursor:pointer;transition:.15s}
    .tag:hover{background:#FD6585;color:#fff}
    .card a{font-size:.85rem;color:#FD6585;text-decoration:none;word-break:break-all}
    .card button{border:none;background:none;cursor:pointer;font-weight:600;font-size:.9rem;color:#FD6585;margin-right:10px}
    .empty{color:rgba(255,255,255,.9);font-weight:500;text-align:center;margin-top:40px}
    .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);display:flex;align-items:center;justify-content:center;z-index:100;visibility:hidden;opacity:0;transition:opacity .25s}
    .modal.active{visibility:visible;opacity:1}
    .modal img{max-width:90%;max-height:90%;border-radius:10px;box-shadow:0 10px 40px rgba(0,0,0,.5)}
    .modal-box{background:#fff;border-radius:20px;padding:20px;width:90%;max-width:500px;display:flex;flex-direction:column;gap:10px}
    @media (max-width:600px){body{padding:20px 10px} h1{font-size:1.6rem}}
  </style>
</head>
<body>
  <h1>ğŸ¨ Design Insight Curator</h1>

  <div class="input-container">
    <input id="titleInput" type="text" placeholder="ì¸ì‚¬ì´íŠ¸ ì œëª©" />
    <textarea id="descInput" rows="3" placeholder="ì•„ì´ë””ì–´ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
    <input id="urlInput" type="url" placeholder="ì°¸ê³  URL (ì„ íƒ)" />
    <input id="tagInput" type="text" placeholder="íƒœê·¸ (ì‰¼í‘œë¡œ êµ¬ë¶„)" />
    <select id="categoryInput">
      <option value="">ì¹´í…Œê³ ë¦¬ ì„ íƒ</option>
      <option value="ë””ìì¸">ë””ìì¸</option>
      <option value="í…Œí¬">í…Œí¬</option>
      <option value="UX">UX</option>
      <option value="ë¸Œëœë”©">ë¸Œëœë”©</option>
      <option value="ê¸°íƒ€">ê¸°íƒ€</option>
    </select>
    <input id="imageInput" type="file" accept="image/*" />
    <img id="preview" style="width:100%;border-radius:10px;display:none" alt="ë¯¸ë¦¬ë³´ê¸°"/>
    <button class="add-btn" id="addBtn">+ ì¸ì‚¬ì´íŠ¸ ì¶”ê°€</button>
  </div>

  <div class="filter-bar">
    <input type="text" id="searchInput" placeholder="ì œëª© ë˜ëŠ” íƒœê·¸ ê²€ìƒ‰..." />
    <select id="categoryFilter">
      <option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
      <option value="ë””ìì¸">ë””ìì¸</option>
      <option value="í…Œí¬">í…Œí¬</option>
      <option value="UX">UX</option>
      <option value="ë¸Œëœë”©">ë¸Œëœë”©</option>
      <option value="ê¸°íƒ€">ê¸°íƒ€</option>
    </select>
  </div>

  <div class="card-grid" id="cardGrid"></div>
  <p class="empty" id="emptyMessage">ì•„ì§ ë“±ë¡ëœ ì¸ì‚¬ì´íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</p>

  <!-- ì´ë¯¸ì§€ í™•ëŒ€ ëª¨ë‹¬ -->
  <div class="modal" id="imageModal" onclick="closeModal()">
    <img id="modalImage" src="" alt="ì›ë³¸ ì´ë¯¸ì§€" />
  </div>

  <!-- ìˆ˜ì • ëª¨ë‹¬ -->
  <div class="modal" id="editModal">
    <div class="modal-box" onclick="event.stopPropagation()">
      <h2>ì¸ì‚¬ì´íŠ¸ ìˆ˜ì •</h2>
      <input id="editTitle" type="text" placeholder="ì œëª©" />
      <textarea id="editDesc" rows="3" placeholder="ë‚´ìš©"></textarea>
      <input id="editURL" type="url" placeholder="URL" />
      <input id="editTags" type="text" placeholder="íƒœê·¸ (ì‰¼í‘œë¡œ êµ¬ë¶„)" />
      <select id="editCategory">
        <option value="">ì¹´í…Œê³ ë¦¬ ì„ íƒ</option>
        <option value="ë””ìì¸">ë””ìì¸</option>
        <option value="í…Œí¬">í…Œí¬</option>
        <option value="UX">UX</option>
        <option value="ë¸Œëœë”©">ë¸Œëœë”©</option>
        <option value="ê¸°íƒ€">ê¸°íƒ€</option>
      </select>
      <input id="editImage" type="file" accept="image/*" />
      <img id="editPreview" style="width:100%;border-radius:10px;display:none" alt="ìˆ˜ì • ë¯¸ë¦¬ë³´ê¸°"/>
      <div style="display:flex;justify-content:flex-end;gap:10px">
        <button id="cancelEditBtn">ì·¨ì†Œ</button>
        <button id="saveEditBtn" style="background:linear-gradient(135deg,#FD6585,#FFD3A5);color:#fff;border:none;border-radius:20px;padding:8px 20px;cursor:pointer">ì €ì¥</button>
      </div>
    </div>
  </div>

  <script>
    // ë°ì´í„° ë¡œë“œ
    let insights = JSON.parse(localStorage.getItem("insights") || "[]");
    let editIndex = null;

    // DOM ìš”ì†Œ
    const grid = document.getElementById("cardGrid");
    const preview = document.getElementById("preview");
    const emptyMsg = document.getElementById("emptyMessage");
    const imageInput = document.getElementById("imageInput");
    const addBtn = document.getElementById("addBtn");
    const searchInput = document.getElementById("searchInput");
    const categoryFilter = document.getElementById("categoryFilter");
    const editModal = document.getElementById("editModal");
    const imageModal = document.getElementById("imageModal");
    const modalImage = document.getElementById("modalImage");

    // ì•ˆì „í•˜ê²Œ ì „ì—­ì— ë°”ì¸ë”© (ì¸ë¼ì¸ í•¸ë“¤ëŸ¬ì™€ í˜¸í™˜)
    window.previewImage = function (e) {
      const file = e.target.files && e.target.files[0];
      if (!file) {
        preview.style.display = "none";
        preview.src = "";
        return;
      }
      const reader = new FileReader();
      reader.onload = ev => {
        preview.src = ev.target.result;
        preview.style.display = "block";
      };
      reader.readAsDataURL(file);
    };

    window.previewEditImage = function (e) {
      const file = e.target.files && e.target.files[0];
      const editPreview = document.getElementById("editPreview");
      if (!file) {
        editPreview.style.display = "none";
        editPreview.src = "";
        return;
      }
      const reader = new FileReader();
      reader.onload = ev => {
        editPreview.src = ev.target.result;
        editPreview.style.display = "block";
      };
      reader.readAsDataURL(file);
    };

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²° (ì¸ë¼ì¸ ëŒ€ì‹  JSì—ì„œ ì—°ê²°í•´ë„ ì•ˆì „)
    imageInput.addEventListener("change", (e) => window.previewImage(e));
    document.getElementById("editImage").addEventListener("change", (e) => window.previewEditImage(e));

    // ì¶”ê°€ ë²„íŠ¼
    addBtn.addEventListener("click", addInsight);

    // ê²€ìƒ‰/ì¹´í…Œê³ ë¦¬ í•„í„° ì…ë ¥
    searchInput.addEventListener("input", filterInsights);
    categoryFilter.addEventListener("change", filterInsights);

    // í¸ì§‘ ëª¨ë‹¬ ë²„íŠ¼ ì—°ê²°
    document.getElementById("cancelEditBtn").addEventListener("click", closeEditModal);
    document.getElementById("saveEditBtn").addEventListener("click", saveEdit);

    // ì´ˆê¸° ëœë”
    renderInsights();

    // --- ê¸°ëŠ¥ êµ¬í˜„ ---
    function saveToStorage() {
      localStorage.setItem("insights", JSON.stringify(insights));
    }

    function addInsight() {
      const title = document.getElementById("titleInput").value.trim();
      const desc = document.getElementById("descInput").value.trim();
      const url = document.getElementById("urlInput").value.trim();
      const tags = document.getElementById("tagInput").value.split(",").map(t => t.trim()).filter(Boolean);
      const category = document.getElementById("categoryInput").value;
      const image = preview.src && preview.style.display === "block" ? preview.src : "";

      if (!title || !desc) { alert("ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }

      insights.push({ title, description: desc, url, tags, category, image, id: Date.now() });
      saveToStorage();
      clearForm();
      renderInsights();
    }

    function clearForm() {
      document.getElementById("titleInput").value = "";
      document.getElementById("descInput").value = "";
      document.getElementById("urlInput").value = "";
      document.getElementById("tagInput").value = "";
      document.getElementById("categoryInput").value = "";
      imageInput.value = "";
      preview.src = "";
      preview.style.display = "none";
    }

    function renderInsights(filteredList) {
      const list = Array.isArray(filteredList) ? filteredList : insights;
      grid.innerHTML = "";
      if (!list.length) { emptyMsg.style.display = "block"; return; }
      emptyMsg.style.display = "none";

      list.forEach((insight, displayIndex) => {
        // displayIndexëŠ” ë Œë”ëœ ë¦¬ìŠ¤íŠ¸ ìˆœì„œ. ì‹¤ì œ ì›ë³¸ ë°°ì—´ì˜ ì¸ë±ìŠ¤ëŠ” ì°¾ê¸° í•„ìš”.
        // ì›ë³¸ ë°°ì—´ì˜ ì¸ë±ìŠ¤(ë°ì´í„° ê¸°ì¤€)ë¥¼ idë¡œ ì°¾ëŠ”ë‹¤.
        const dataIndex = insights.findIndex(i => i.id === insight.id);
        const card = document.createElement("div");
        card.className = "card";
        card.draggable = true;
        card.dataset.index = dataIndex;

        const imgHtml = insight.image ? `<img src="${insight.image}" draggable="false" onclick="openModal('${insight.image}')"/>` : "";
        const tagsHtml = (insight.tags && insight.tags.length) ? `<div class="tags">${insight.tags.map(t => `<span class='tag' onclick="filterByTag('${escapeHtml(t)}')">${escapeHtml(t)}</span>`).join("")}</div>` : "";

        card.innerHTML = `
          ${imgHtml}
          <div class="card-content">
            <h3>${escapeHtml(insight.title)}</h3>
            <p>${escapeHtml(insight.description)}</p>
            ${insight.url ? `<a href="${escapeAttr(insight.url)}" target="_blank" rel="noopener">${escapeHtml(insight.url)}</a>` : ""}
            ${tagsHtml}
            <small>ğŸ“ ${escapeHtml(insight.category || "ê¸°íƒ€")}</small>
            <div>
              <button onclick="editInsightById(${insight.id})">ìˆ˜ì •</button>
              <button onclick="deleteInsightById(${insight.id})">ì‚­ì œ</button>
            </div>
          </div>
        `;

        // ì´ë¯¸ì§€ ë“œë˜ê·¸ ë¶„ë¦¬ ë°©ì§€: ì´ë¯¸ì§€ë¥¼ ì§ì ‘ ë“œë˜ê·¸í•˜ë©´ ë¸Œë¼ìš°ì € ê¸°ë³¸ë™ì‘ ë°©ì§€
        const imgEl = card.querySelector("img");
        if (imgEl) imgEl.addEventListener("dragstart", e => e.preventDefault());

        addDragEvents(card);
        grid.appendChild(card);
      });
    }

    // ì•ˆì „í•œ í…ìŠ¤íŠ¸/ì†ì„± ì´ìŠ¤ì¼€ì´í”„
    function escapeHtml(str = "") {
      return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[s]));
    }
    function escapeAttr(s = "") { return encodeURI(String(s)); }

    // --- ëª¨ë‹¬ ì´ë¯¸ì§€ ---
    window.openModal = function (src) {
      imageModal.classList.add("active");
      modalImage.src = src;
    };
    window.closeModal = function () { imageModal.classList.remove("active"); modalImage.src = ""; };

    // --- í¸ì§‘ (id ê¸°ë°˜) ---
    window.editInsightById = function(id) {
      const idx = insights.findIndex(i => i.id === id);
      if (idx === -1) return;
      editIndex = idx;
      const i = insights[idx];
      document.getElementById("editTitle").value = i.title;
      document.getElementById("editDesc").value = i.description;
      document.getElementById("editURL").value = i.url || "";
      document.getElementById("editTags").value = (i.tags || []).join(", ");
      document.getElementById("editCategory").value = i.category || "";
      document.getElementById("editPreview").src = i.image || "";
      document.getElementById("editPreview").style.display = i.image ? "block" : "none";
      editModal.classList.add("active");
    };

    function saveEdit() {
      if (editIndex === null) return;
      const newTitle = document.getElementById("editTitle").value.trim();
      const newDesc = document.getElementById("editDesc").value.trim();
      const newURL = document.getElementById("editURL").value.trim();
      const newTags = document.getElementById("editTags").value.split(",").map(t => t.trim()).filter(Boolean);
      const newCategory = document.getElementById("editCategory").value;
      const newImage = document.getElementById("editPreview").src || "";

      if (!newTitle || !newDesc) { alert("ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }

      insights[editIndex] = { ...insights[editIndex], title: newTitle, description: newDesc, url: newURL, tags: newTags, category: newCategory, image: newImage };
      saveToStorage();
      closeEditModal();
      renderInsights();
    }

    function closeEditModal() {
      editModal.classList.remove("active");
      editIndex = null;
      document.getElementById("editImage").value = "";
      document.getElementById("editPreview").src = "";
      document.getElementById("editPreview").style.display = "none";
    }

    // --- ì‚­ì œ (id ê¸°ë°˜) ---
    window.deleteInsightById = function(id) {
      const idx = insights.findIndex(i => i.id === id);
      if (idx === -1) return;
      if (!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
      insights.splice(idx,1);
      saveToStorage();
      renderInsights();
    };

    // --- ë“œë˜ê·¸ ì•¤ ë“œë¡­ ---
    function addDragEvents(card) {
      card.addEventListener("dragstart", e => { e.target.classList.add("dragging"); });
      card.addEventListener("dragend", e => {
        e.target.classList.remove("dragging");
        updateOrderByDOM();
      });
      card.addEventListener("dragover", e => {
        e.preventDefault();
        const dragging = document.querySelector(".dragging");
        const cards = [...grid.querySelectorAll(".card:not(.dragging)")];
        const next = cards.find(c => e.clientY <= c.getBoundingClientRect().top + c.offsetHeight / 2);
        grid.insertBefore(dragging, next);
      });
    }

    function updateOrderByDOM() {
      const newOrder = [];
      grid.querySelectorAll(".card").forEach(c => {
        const id = insights[c.dataset.index]?.id;
        // if dataset.index mapping changed (because we render by id), use card content's title to find id
        if (!id) {
          // try to find by title shown (fallback)
          const titleEl = c.querySelector("h3");
          const titleText = titleEl ? titleEl.textContent : null;
          const found = insights.find(i => i.title === titleText);
          if (found) newOrder.push(found);
        } else {
          const found = insights.find(i => i.id === id);
          if (found) newOrder.push(found);
        }
      });
      // if newOrder empty (edge cases), skip; otherwise apply
      if (newOrder.length) { insights = newOrder; saveToStorage(); renderInsights(); }
    }

    // --- í•„í„°/ê²€ìƒ‰/íƒœê·¸ í´ë¦­ ---
    function filterInsights() {
      const q = (searchInput.value || "").toLowerCase();
      const cat = categoryFilter.value;
      const filtered = insights.filter(i => {
        const matchCategory = !cat || (i.category === cat);
        const matchTitle = (i.title || "").toLowerCase().includes(q);
        const matchTag = (i.tags || []).some(t => t.toLowerCase().includes(q));
        // if q empty, matchTitle false but matchTag false: treat as match
        const matchQuery = !q || matchTitle || matchTag;
        return matchCategory && matchQuery;
      });
      renderInsights(filtered);
    }

    window.filterByTag = function(tag) {
      searchInput.value = tag;
      filterInsights();
    };

    // --- ìœ í‹¸: ì•ˆì „í•˜ê²Œ ë Œë”ëœ ì¹´ë“œì˜ dataset.index ì—…ë°ì´íŠ¸ (renderInsights ë‚´ì—ì„œ í˜¸ì¶œ)
    // NOTE: Because we render by 'insights' and use id mapping, we set dataset.index to actual index in insights array
    function renderInsights(list) {
      // replaced earlier renderInsights with safe wrapper
      const arr = Array.isArray(list) ? list : insights;
      grid.innerHTML = "";
      if (!arr.length) { emptyMsg.style.display = "block"; return; }
      emptyMsg.style.display = "none";

      arr.forEach(item => {
        const dataIndex = insights.findIndex(i => i.id === item.id);
        const card = document.createElement("div");
        card.className = "card";
        card.draggable = true;
        card.dataset.index = dataIndex;

        const imgHtml = item.image ? `<img src="${item.image}" draggable="false" onclick="openModal('${item.image}')"/>` : "";
        const tagsHtml = (item.tags && item.tags.length) ? `<div class="tags">${item.tags.map(t => `<span class='tag' onclick="filterByTag('${escapeHtml(t)}')">${escapeHtml(t)}</span>`).join("")}</div>` : "";

        card.innerHTML = `
          ${imgHtml}
          <div class="card-content">
            <h3>${escapeHtml(item.title)}</h3>
            <p>${escapeHtml(item.description)}</p>
            ${item.url ? `<a href="${escapeAttr(item.url)}" target="_blank" rel="noopener">${escapeHtml(item.url)}</a>` : ""}
            ${tagsHtml}
            <small>ğŸ“ ${escapeHtml(item.category || "ê¸°íƒ€")}</small>
            <div>
              <button onclick="editInsightById(${item.id})">ìˆ˜ì •</button>
              <button onclick="deleteInsightById(${item.id})">ì‚­ì œ</button>
            </div>
          </div>
        `;

        const imgEl = card.querySelector("img");
        if (imgEl) imgEl.addEventListener("dragstart", e => e.preventDefault());

        addDragEvents(card);
        grid.appendChild(card);
      });
    }

    // renderInsights wrapper call to initialize correctly
    renderInsights();

    // --- ë„ìš°ë¯¸ (escape) ---
    function escapeHtml(str = "") {
      return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[s]));
    }
    function escapeAttr(s = "") { try { return encodeURI(String(s)); } catch { return ""; } }

    // Expose some utilities globally (for inline onclick)
    window.filterInsights = filterInsights;
    window.editInsight = window.editInsightById;
    window.deleteInsight = window.deleteInsightById;

  </script>
</body>
</html>
